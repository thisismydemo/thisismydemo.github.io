<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Azure Stack HCI - Part IV - Scale-out Azure Stack HCI Single Node Cluster - This Is My Demo</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="This is a series of blogs about my experiences with Azure Stack HCI">
		<meta property="og:title" content="Azure Stack HCI - Part IV - Scale-out Azure Stack HCI Single Node Cluster" />
<meta property="og:description" content="This is a series of blogs about my experiences with Azure Stack HCI" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://thisismydemo.cloud/post/azure-stack-hci-part-iv-scale-azure-stack-hci-single-node-cluster/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-10-20T21:38:07+00:00" />
<meta property="article:modified_time" content="2023-10-23T21:34:49+00:00" />


		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Azure Stack HCI - Part IV - Scale-out Azure Stack HCI Single Node Cluster"/>
<meta name="twitter:description" content="This is a series of blogs about my experiences with Azure Stack HCI"/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
<script async src="https://www.googletagmanager.com/gtag/js?id=G-C78KZ1DN40"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-C78KZ1DN40', { 'anonymize_ip': false });
}
</script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="This Is My Demo" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">This Is My Demo</div>
					<div class="logo__tagline">Another blog about clouds... Private Clouds, Public Clouds, Hybrid Clouds, and pretty little fluffy clouds?</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Azure Stack HCI - Part IV - Scale-out Azure Stack HCI Single Node Cluster</h1>
			<p class="post__lead">This is a series of blogs about my experiences with Azure Stack HCI</p>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2023-10-20T21:38:07Z">October 20, 2023</time>
	<time class="meta__text" datetime="2023-10-23T21:34:49Z">(Last Modified: October 23, 2023)</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/azure-stack-hci/" rel="category">Azure Stack HCI</a>
	</span>
</div></div>
		</header>
		
	<figure class="post__thumbnail thumbnail">
		
		<img class="thumbnail__image" src="/img/azshci-series/azure-stack-hci.png" alt="Azure Stack HCI - Part IV - Scale-out Azure Stack HCI Single Node Cluster">
		
	</figure><div class="content post__content clearfix">
			<p>In this blog series I plan to blog about everything I know about Azure Stack HCI. So, it should be a very short blog series. Just kidding. Again, I tend to blog about subjects that I am currently working on or will be currently working on. So, Azure Stack HCI is fresh on my mind again these days.</p>
<p>This blog will be about scaling out a single-node Azure Stack HCI cluster up to a two-node cluster.  My previous blog, <a href="https://thisismydemo.cloud/post/azure-stack-hci-part-iii-advanced-deployment-single-node-cluster/">Azure Stack HCI - Part III - Advance Deployment of A Single Node Cluster</a> discussed my experiences deploying a single-node cluster.  There is a lot of information about my environment, how I setup my lab, and more that would be good to know before continuing with this blog. However, I will try and include as much as I can within this blog to make sense of everything.</p>
<p>So this blog will cover the following:</p>
<ul>
<li><a href="#review-of-previous-blog">Review Of Previous Blog</a>
<ul>
<li><a href="#what-it-looks-like-now">What it looks like now</a></li>
</ul>
</li>
<li><a href="#the-variables">The Variables</a></li>
<li><a href="#configuring-the-second-node">Configuring the second node</a>
<ul>
<li><a href="#run-azure-stack-hci-environment-checker">Run Azure Stack HCI Environment Checker</a></li>
<li><a href="#update-server">Update Server</a></li>
<li><a href="#install-windows-features">Install Windows Features</a></li>
<li><a href="#restart-servers">Restart Servers</a></li>
<li><a href="#configure-os-settings">Configure OS Settings</a>
<ul>
<li><a href="#configure-active-memory">Configure Active Memory</a></li>
<li><a href="#configure-high-performance-plan">Configure High Performance Plan</a></li>
<li><a href="#delete-storage-pool">Delete Storage Pool</a></li>
<li><a href="#configure-max-envelope-size">Configure Max Envelope Size</a></li>
<li><a href="#configure-maxtimeout">Configure MaxTimeOut</a></li>
<li><a href="#rename-network-adapters">Rename Network Adapters</a></li>
</ul>
</li>
<li><a href="#configure-os-security">Configure OS Security</a></li>
<li><a href="#restart-computer">Restart Computer</a></li>
</ul>
</li>
<li><a href="#configure-networking-with-network-atc">Configure Networking with Network ATC</a>
<ul>
<li><a href="#install-features-if-needed">Install Features (If Needed)</a></li>
<li><a href="#configure-management-server-for-atc-management">Configure Management Server for ATC Management</a></li>
<li><a href="#deploy-new-intent-configurations">Deploy new Intent Configurations</a></li>
</ul>
</li>
<li><a href="#configure-cluster">Configure Cluster</a>
<ul>
<li><a href="#configure-witness">Configure Witness</a></li>
<li><a href="#add-node-to-cluster">Add Node To Cluster</a></li>
</ul>
</li>
<li><a href="#install-network-hud-netatc">Install Network HUD (NetATC)</a></li>
<li><a href="#complete-netatc-configurations">Complete NetATC Configurations</a>
<ul>
<li><a href="#check-netatc-configurations">Check NetATC Configurations</a></li>
<li><a href="#enable-cluster-aware-updating">Enable Cluster-Aware-Updating</a></li>
</ul>
</li>
<li><a href="#configure-cluster-storage">Configure Cluster Storage</a>
<ul>
<li><a href="#storage-fault-domain-changes">Storage Fault Domain Changes</a></li>
<li><a href="#create-volumes">Create Volumes</a></li>
<li><a href="#align-volumes">Align Volumes</a></li>
</ul>
</li>
<li><a href="#verify-and-testify">Verify and Testify?</a></li>
<li><a href="#final-thoughts">Final Thoughts</a></li>
</ul>
<p>Remember, I am building this solution on a Single Node cluster and I will try to explain how to do it not only on an AzureVM but try to explain how it would be done on physical hardware if that process is different.  Since I do have plans to scale out this cluster, I will keep that in mind as I deploy this first node as well.  Knowing that I will add a second and a third and a fourth node in the future.</p>
<h2 id="review-of-previous-blog">Review Of Previous Blog</h2>
<p>What did I do in my last blog? Good question. First, most of what I did I learned from a few others including <a href="https://learn.microsoft.com/en-us/azure-stack/hci/">Microsoft Learn documentation on Azure Stack HCI</a>. My environment is deployed on an Azure VM using the<a href="https://github.com/DellGEOS/HybridJumpstart/tree/main">Hybrid Jump Start</a> was created and being worked on by <strong><a href="https://twitter.com/mattmcspirit">Matt McSpirit</a></strong>. The Hybrid Jump Start is built with <strong><a href="https://twitter.com/jaromirkaspar">Jaromir Kaspar</a></strong> MSLab project.  Also, a lot of my scripts I am using comes from  Jaromir&rsquo;s <a href="https://github.com/DellGEOS/AzureStackHOLs">Azure Stack HOLs</a> Github repo. There is also a <a href="https://azurestackhci.slack.com">Slack Channel dedicated to Azure Stack HCI</a> that I pull some information from as well.</p>
<p>I have an Azure VM running with Hyper-V. Within that AzureVM I have 6 VM&rsquo;s. A domain controller, a Windows Admin Center Gateway VM, and 4 VM&rsquo;s running the Azure Stack HCI OS. All the systems are joined to a demo domain. The only server, AzSHCI01 is configured and joined to my AzSHCI-Cluster that was deployed in my last blog.  I am using Network ATC with only one intent configuration, which currently only uses 2 of the 4 virtual nics on that virtual machine. The intent also is only configured to use Compute and Management traffic.  Since this is a single node, I didn&rsquo;t need to configure the SMB nics, as well as a Witness.</p>
<p>So this blog will continue where we left off. We have a working single-node Azure Stack HCI cluster. However, we now want to scale that cluster from one-node to a two-node cluster.</p>
<h3 id="what-it-looks-like-now">What it looks like now</h3>
<p>The existing environment currently looks like this. From within the Failover Cluster Manager we can see that our cluster is running with our single-node, and a single cluster network for management and compute.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-21%20122735.png" alt=""></p>
<p>Here we can see that our cluster has been registered to Azure and is being managed by Azure Arc.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-21%20122806.png" alt=""></p>
<p>Our single node is showing up from within the Windows Admin Center.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-21%20122848.png" alt=""></p>
<p>Our two volumes are up and healthy.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-21%20122924.png" alt=""></p>
<p>If I go into Azure Arc, I can see that my cluster is registered and connected.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-21%20122951.png" alt=""></p>
<p>As well as my single-node, is registered and connected.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-21%20123010.png" alt=""></p>
<p>So now that we are finished with my environment. It is time to scale our this single-node Azure Stack HCI cluster and add a second node.</p>
<hr>
<h2 id="the-variables">The Variables</h2>
<p>As I mentioned above, a good chunk of my scripts come from others. Mostly from Jaromir&rsquo;s Azure Stack Hands On Lab Github repo. I have taken them re-configured them a little to work in my environment both on a virtual machine and moving  forward something I can use for automation on bare metal deployments.</p>
<p>Since this is going to be focused on getting my 2nd node configured and then joined to my cluster I have focused these variables knowing this.</p>
<pre tabindex="0"><code>#Please fill in variable with node name: example: $ClusterNode = &#34;AzSHCI1&#34;
$ClusterNode = &#34;AzSHCI2&#34;

#Existing Cluster Name
$ClusterName = &#34;AzSHCI-Cluster&#34;

#Cluster-Aware-Updating role name
$CAURoleName = &#34;AzSHCI-Cl-CAU&#34;

#Deploy network using Network ATC? https://learn.microsoft.com/en-us/azure-stack/hci/manage/manage-network-atc?tabs=22H2
$NetATC = $True

#Perform Windows update? (for more info visit WU Scenario https://github.com/microsoft/WSLab/tree/dev/Scenarios/Windows%20Update)
$WindowsUpdate = &#34;Recommended&#34; #Can be &#34;All&#34;,&#34;Recommended&#34; or &#34;None&#34;

#Dell updates
#If running on physical Dell servers change this to $True
$DellUpdates = $False

#Witness type
$WitnessType = &#34;FileShare&#34; #or Cloud
$WitnessServer = &#34;DC&#34; #name of server where witness will be configured

#For Cloud  witness
    $CloudWitnessStorageAccountName=&#34;MyStorageAccountName&#34;
    $CloudWitnessStorageKey=&#34;qi8QB/VSHHiA9lSvz1kEIEt0JxIucPL3l99nRHhkp+n1Lpabu4Ydi7Ih192A4VW42vccIgUnrXxxxxxxxxxxxx==&#34;
    $CloudWitnessEndpoint=&#34;core.windows.net&#34;
    #&gt;

#Delete Storage Pool (like after reinstall there might be data left from old cluster)
$DeletePool = $True
</code></pre><hr>
<h2 id="configuring-the-second-node">Configuring the second node</h2>
<p>So let the fun begin! I am ready to start configuring my second node that will be added to my single-node Azure Stack HCI cluster. The following steps is what we took to get the node configured and ready to join the cluster.</p>
<h3 id="run-azure-stack-hci-environment-checker">Run Azure Stack HCI Environment Checker</h3>
<p>Here we will run the <a href="https://learn.microsoft.com/en-us/azure-stack/hci/manage/use-environment-checker?tabs=connectivity">Azure Stack HCI Environment checker</a>. I don&rsquo;t think it is necessary in my virtualized environment but I will run it anyway. This tool will run some test on each of our servers that we will be joining to this Azure Stack HCI Cluster.</p>
<pre tabindex="0"><code>Install-PackageProvider -Name NuGet -Force
Install-Module -Name AzStackHci.EnvironmentChecker -Force -AllowClobber

$PSSessions = New-PSSession $ClusterNode
Invoke-AzStackHciConnectivityValidation -PsSession $PSSessions
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20074415.png" alt=""></p>
<h3 id="update-server">Update Server</h3>
<p>Now we will run Windows Update to make sure we have the most recent updates installed.</p>
<pre tabindex="0"><code>$RegistryPath = &#39;HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\&#39;
$ComputersInfo = Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
    Get-ItemProperty -Path $using:RegistryPath
}
$ComputersInfo | Select-Object PSComputerName, CurrentBuildNumber, UBR

#Update servers
if ($WindowsUpdate -eq &#34;Recommended&#34;) {
    #Create virtual account to be able to run command without credssp
    Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        New-PSSessionConfigurationFile -RunAsVirtualAccount -Path $env:TEMP\VirtualAccount.pssc
        Register-PSSessionConfiguration -Name &#39;VirtualAccount&#39; -Path $env:TEMP\VirtualAccount.pssc -Force
    } -ErrorAction Ignore
    #sleep a bit
    Start-Sleep 2
    # Run Windows Update via ComObject.
    Invoke-Command -ComputerName $ClusterNode -ConfigurationName &#39;VirtualAccount&#39; {
        $Searcher = New-Object -ComObject Microsoft.Update.Searcher
        $SearchCriteriaAllUpdates = &#34;IsInstalled=0 and DeploymentAction=&#39;Installation&#39; or
                                    IsPresent=1 and DeploymentAction=&#39;Uninstallation&#39; or
                                    IsInstalled=1 and DeploymentAction=&#39;Installation&#39; and RebootRequired=1 or
                                    IsInstalled=0 and DeploymentAction=&#39;Uninstallation&#39; and RebootRequired=1&#34;
        $SearchResult = $Searcher.Search($SearchCriteriaAllUpdates).Updates
        if ($SearchResult.Count -gt 0) {
            $Session = New-Object -ComObject Microsoft.Update.Session
            $Downloader = $Session.CreateUpdateDownloader()
            $Downloader.Updates = $SearchResult
            $Downloader.Download()
            $Installer = New-Object -ComObject Microsoft.Update.Installer
            $Installer.Updates = $SearchResult
            $Result = $Installer.Install()
            $Result
        }
    }
    #remove temporary PSsession config
    Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        Unregister-PSSessionConfiguration -Name &#39;VirtualAccount&#39;
        Remove-Item -Path $env:TEMP\VirtualAccount.pssc
    }
}
elseif ($WindowsUpdate -eq &#34;All&#34;) {
    # Update servers with all updates (including preview)
    Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        New-PSSessionConfigurationFile -RunAsVirtualAccount -Path $env:TEMP\VirtualAccount.pssc
        Register-PSSessionConfiguration -Name &#39;VirtualAccount&#39; -Path $env:TEMP\VirtualAccount.pssc -Force
    } -ErrorAction Ignore
    #sleep a bit
    Start-Sleep 2
    # Run Windows Update via ComObject.
    Invoke-Command -ComputerName $ClusterNode -ConfigurationName &#39;VirtualAccount&#39; {
        $Searcher = New-Object -ComObject Microsoft.Update.Searcher
        $SearchCriteriaAllUpdates = &#34;IsInstalled=0 and DeploymentAction=&#39;Installation&#39; or
                                    IsInstalled=0 and DeploymentAction=&#39;OptionalInstallation&#39; or
                                    IsPresent=1 and DeploymentAction=&#39;Uninstallation&#39; or
                                    IsInstalled=1 and DeploymentAction=&#39;Installation&#39; and RebootRequired=1 or
                                    IsInstalled=0 and DeploymentAction=&#39;Uninstallation&#39; and RebootRequired=1&#34;
        $SearchResult = $Searcher.Search($SearchCriteriaAllUpdates).Updates
        if ($SearchResult.Count -gt 0) {
            $Session = New-Object -ComObject Microsoft.Update.Session
            $Downloader = $Session.CreateUpdateDownloader()
            $Downloader.Updates = $SearchResult
            $Downloader.Download()
            $Installer = New-Object -ComObject Microsoft.Update.Installer
            $Installer.Updates = $SearchResult
            $Result = $Installer.Install()
            $Result
        }
    }
    #remove temporary PSsession config
    Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        Unregister-PSSessionConfiguration -Name &#39;VirtualAccount&#39;
        Remove-Item -Path $env:TEMP\VirtualAccount.pssc
    }
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20080735.png" alt=""></p>
<h3 id="install-windows-features">Install Windows Features</h3>
<p>Here we will install the Windows Features needed on our second node getting it ready to join the cluster. We will also run a script to make sure our management server has all the tools installed as well.</p>
<p>The first step is to make sure our management server is ready. I will install the needed Windows Features that will come into play during our deployment and management of Azure Stack HCI.</p>
<pre tabindex="0"><code>Install-WindowsFeature -Name RSAT-Clustering, RSAT-Clustering-Mgmt, RSAT-Clustering-PowerShell, RSAT-Hyper-V-Tools, RSAT-Feature-Tools-BitLocker-BdeAducExt, RSAT-Storage-Replica
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20081037.png" alt=""></p>
<p>Next we will install the Hyper-V role on our future nodes.  Since I am using a virtual machine, I needed to enabled nested virtulization on my VM. The good thing is, the Hybird Jump Start solution does that for me.</p>
<pre tabindex="0"><code>#install roles and features on servers
#install Hyper-V using DISM if Install-WindowsFeature fails (if nested virtualization is not enabled install-windowsfeature fails)
Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
    $Result = Install-WindowsFeature -Name &#34;Hyper-V&#34; -ErrorAction SilentlyContinue
    if ($result.ExitCode -eq &#34;failed&#34;) {
        Enable-WindowsOptionalFeature -FeatureName Microsoft-Hyper-V -Online -NoRestart 
    }
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20081054.png" alt=""></p>
<p>Now we need to install all the required Windows features on the node that I will be using.</p>
<pre tabindex="0"><code>#define and install other features
$features = &#34;Failover-Clustering&#34;, &#34;RSAT-Clustering-PowerShell&#34;, &#34;Hyper-V-PowerShell&#34;, &#34;NetworkATC&#34;, &#34;NetworkHUD&#34;, &#34;Data-Center-Bridging&#34;, &#34;RSAT-DataCenterBridging-LLDP-Tools&#34;, &#34;FS-SMBBW&#34;, &#34;System-Insights&#34;, &#34;RSAT-System-Insights&#34;
#optional - affects perf even if not enabled on volumes as filter driver is attached (SR,Dedup) and also Bitlocker, that affects a little bit
#$features+=&#34;Storage-Replica&#34;,&#34;RSAT-Storage-Replica&#34;,&#34;FS-Data-Deduplication&#34;,&#34;BitLocker&#34;,&#34;RSAT-Feature-Tools-BitLocker&#34;
Invoke-Command -ComputerName $ClusterNode -ScriptBlock { Install-WindowsFeature -Name $using:features }
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20081252.png" alt=""></p>
<h3 id="restart-servers">Restart Servers</h3>
<p>I added a restart here. We will be restarting the servers again shortly but since this is a VM it boots fast. If this was a physical box I would wait to reboot until after the Security configurations are done.</p>
<pre tabindex="0"><code>Restart-Computer $ClusterNode -Protocol WSMan -Wait -For PowerShell -Force
Start-Sleep 20 # Allow time for reboots to complete fully
Foreach ($Server in $ClusterNode) {
    do { $Test = Test-NetConnection -ComputerName $Server -CommonTCPPort WINRM }while ($test.TcpTestSucceeded -eq $False)
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20081642.png" alt=""></p>
<h3 id="configure-os-settings">Configure OS Settings</h3>
<p>There are a few configurations that I will do along the way for the OS.</p>
<h4 id="configure-active-memory">Configure Active Memory</h4>
<p>Here I will configure Active Memory.</p>
<pre tabindex="0"><code>Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
    Set-ItemProperty -Path HKLM:\System\CurrentControlSet\Control\CrashControl -Name CrashDumpEnabled -value 1
    Set-ItemProperty -Path HKLM:\System\CurrentControlSet\Control\CrashControl -Name FilterPages -value 1
}
</code></pre><h4 id="configure-high-performance-plan">Configure High Performance Plan</h4>
<p>If this was a physical machine we would set the high performance plan. This is not needed on a VM.</p>
<pre tabindex="0"><code>Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
    if ((Get-ComputerInfo).CsSystemFamily -ne &#34;Virtual Machine&#34;) {
        powercfg /SetActive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
    }
}
</code></pre><p>Let&rsquo;s check the settings now:</p>
<pre tabindex="0"><code>Invoke-Command -ComputerName $ClusterNode -ScriptBlock { powercfg /list }
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20081909.png" alt=""></p>
<h4 id="delete-storage-pool">Delete Storage Pool</h4>
<p>So in my previous blog I discussed a little about how dangerous a script like this can be. So be careful.</p>
<pre tabindex="0"><code>if ($DeletePool) {
    #Grab pools
    $StoragePools = Get-StoragePool -CimSession $ClusterNode -IsPrimordial $False -ErrorAction Ignore
    #remove pools if any
    if ($StoragePools) {
        $StoragePools | Remove-StoragePool -Confirm:0
    }
    #Reset disks (to clear spaces metadata)
    Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        Get-PhysicalDisk -CanPool $True | Reset-PhysicalDisk
    }
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20082312.png" alt=""></p>
<h4 id="configure-max-envelope-size">Configure Max Envelope Size</h4>
<p>Now we will configure our Max Envelope size. This changes the max envelope size to be 8KB in order to copy files using PSSession.</p>
<pre tabindex="0"><code>Invoke-Command -ComputerName $ClusterNode -ScriptBlock { Set-Item -Path WSMan:\localhost\MaxEnvelopeSizekb -Value 8192 }
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20082428.png" alt=""></p>
<h4 id="configure-maxtimeout">Configure MaxTimeOut</h4>
<pre tabindex="0"><code>if ((Get-CimInstance -ClassName win32_computersystem -CimSession $ClusterNode).Manufacturer -like &#34;*Dell Inc.&#34;) {
    Invoke-Command -ComputerName $ClusterNode -ScriptBlock { Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\spaceport\Parameters -Name HwTimeout -Value 0x00002710 }
}
if ((Get-CimInstance -ClassName win32_computersystem -CimSession $ClusterNode).Model -eq &#34;Virtual Machine&#34;) {
    Invoke-Command -ComputerName $ClusterNode -ScriptBlock { Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\spaceport\Parameters -Name HwTimeout -Value 0x00007530 }
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20082447.png" alt=""></p>
<h4 id="rename-network-adapters">Rename Network Adapters</h4>
<p>I did this for my systems. It isn&rsquo;t necessary but I do it.</p>
<pre tabindex="0"><code>Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
    if ((Get-ComputerInfo).CsSystemFamily -eq &#34;Virtual Machine&#34;) {
        Rename-NetAdapter -Name &#34;Ethernet&#34; -NewName &#34;MGT01&#34;
        Rename-NetAdapter -Name &#34;Ethernet 2&#34; -NewName &#34;MGMT02&#34;
        Rename-NetAdapter -Name &#34;Ethernet 3&#34; -NewName &#34;SMB01&#34;
        Rename-NetAdapter -Name &#34;Ethernet 4&#34; -NewName &#34;SMB02&#34;
    }
}

#Verify Network Adapters
Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
    Get-NetAdapter
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20082536.png" alt=""></p>
<h3 id="configure-os-security">Configure OS Security</h3>
<p>Time to do some security configurations. In my lab environment running on a VM I wouldn&rsquo;t need to run these. Some of them I would if I knew I was keeping this environment up for training or other reasons.</p>
<pre tabindex="0"><code> Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
    #Device Guard
    #REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard&#34; /v &#34;Locked&#34; /t REG_DWORD /d 1 /f 
    REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard&#34; /v &#34;EnableVirtualizationBasedSecurity&#34; /t REG_DWORD /d 1 /f
    #there s different setting for VM and Bare metal
    if ((Get-CimInstance -ClassName win32_computersystem).Model -eq &#34;Virtual Machine&#34;) {
        REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard&#34; /v &#34;RequirePlatformSecurityFeatures&#34; /t REG_DWORD /d 1 /f
    }
    else {
        REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard&#34; /v &#34;RequirePlatformSecurityFeatures&#34; /t REG_DWORD /d 3 /f
    }
    REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard&#34; /v &#34;RequireMicrosoftSignedBootChain&#34; /t REG_DWORD /d 1 /f

    #Cred Guard
    REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&#34; /v &#34;LsaCfgFlags&#34; /t REG_DWORD /d 1 /f

    #System Guard Secure Launch (bare meta only)
    #https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-system-guard/system-guard-secure-launch-and-smm-protection
    REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\SystemGuard&#34; /v &#34;Enabled&#34; /t REG_DWORD /d 1 /f

    #HVCI
    REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\HypervisorEnforcedCodeIntegrity&#34; /v &#34;Enabled&#34; /t REG_DWORD /d 1 /f
    #REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\HypervisorEnforcedCodeIntegrity&#34; /v &#34;Locked&#34; /t REG_DWORD /d 1 /f
    REG ADD &#34;HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\HypervisorEnforcedCodeIntegrity&#34; /v &#34;HVCIMATRequired&#34; /t REG_DWORD /d 1 /f
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20083141.png" alt=""></p>
<h3 id="restart-computer">Restart Computer</h3>
<p>Let us reboot to make sure all these changes will take and get our node ready to configure the cluster.</p>
<pre tabindex="0"><code>Restart-Computer $ClusterNode -Protocol WSMan -Wait -For PowerShell -Force
Start-Sleep 20 #Failsafe as Hyper-V needs 2 reboots and sometimes it happens, that during the first reboot the restart-computer evaluates the machine is up
#make sure computers are restarted
Foreach ($Server in $ClusterNode) {
    do { $Test = Test-NetConnection -ComputerName $Server -CommonTCPPort WINRM }while ($test.TcpTestSucceeded -eq $False)
}
</code></pre><hr>
<h2 id="configure-networking-with-network-atc">Configure Networking with Network ATC</h2>
<p>Network ATC is a tool to assist with the configuration of our Azure Stack HCI networking.  Dealing with networking in the past could be complex and like me, would always be an error-prone process. Network ATC will help us with:</p>
<ul>
<li>Reduce host networking deployment time, complexity, and errors</li>
<li>Deploy the latest Microsoft validated and supported best practices</li>
<li>Ensure configuration consistency across the cluster</li>
<li>Eliminate configuration drift</li>
</ul>
<h3 id="install-features-if-needed">Install Features (If Needed)</h3>
<p>Since I have used my management machine in the past and most likely have already had the features installed I wouldn&rsquo;t necessarily need to install them again. Just in case I ran the following PowerShell script.</p>
<pre tabindex="0"><code>    Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        Install-WindowsFeature -Name NetworkATC, Data-Center-Bridging, RSAT-Clustering-PowerShell, RSAT-Hyper-V-Tools, FS-SMBBW
    }
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20084058.png" alt=""></p>
<h3 id="configure-management-server-for-atc-management">Configure Management Server for ATC Management</h3>
<p>Next we will copy over the NetworkATC modules to our management machine in order to be able to manage Network ATC from our management server.</p>
<pre tabindex="0"><code>    $session = New-PSSession -ComputerName $ClusterNode
    $items = &#34;C:\Windows\System32\WindowsPowerShell\v1.0\Modules\NetworkATC&#34;, &#34;C:\Windows\System32\NetworkAtc.Driver.dll&#34;, &#34;C:\Windows\System32\Newtonsoft.Json.dll&#34;, &#34;C:\Windows\System32\NetworkAtcFeatureStaging.dll&#34;
    foreach ($item in $items) {
        Copy-Item -FromSession $session -Path $item -Destination $item -Recurse -Force
    }
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20084231.png" alt=""></p>
<h3 id="deploy-new-intent-configurations">Deploy new Intent Configurations</h3>
<p>This section I will deploy my Storage Intent configuration. This will target the ClusterName so it will actually be running on AzsHCI01, my first node. This will get our cluster ready to have two network configurations. One for Compute/Management and then a separate switch for Storage traffic only.</p>
<p>So here is an example of the configuration that was deployed in my first blog.  We have 4 virtual nics. We are using nic01 and nic02 for our Mgmt &amp; Compute Team that was configured with our ConvergedIntent configuration.</p>
<p><img src="/img/azshci-series/part-iii/network-atc-6-disaggregated-management-compute.png" alt=""></p>
<p>What we are about to do is deploy another Intent configuration that will add a Storage Intent. The only thing that is different between my deployment and the image below is my compute and management are on one Intent configuration, which in turn is a separate virtual switch from my storage intent and virtual switch.</p>
<p><img src="/img/azshci-series/part-iii/network-atc-3-separate-management-compute-storage.png" alt=""></p>
<p>Here is the PowerShell that will allow me to deploy our configurations.</p>
<pre tabindex="0"><code>#if virtual environment, then skip RDMA config
    if ((Get-CimInstance -ClassName win32_computersystem -CimSession $ClusterNode).Model -eq &#34;Virtual Machine&#34;) {
        Import-Module NetworkATC
        #virtual environment (skipping RDMA config)
        $AdapterOverride = New-NetIntentAdapterPropertyOverrides
        $AdapterOverride.NetworkDirect = 0
        Add-NetIntent -ClusterName $ClusterName -Name StorageIntent -Storage -AdapterName &#34;SMB01&#34;, &#34;SMB02&#34; -AdapterPropertyOverrides $AdapterOverride -Verbose
    }
    else {
        #on real hardware you can configure RDMA
        #grab fastest adapters names (assuming that we are deploying converged intent with just Mellanox or Intel E810)
        $FastestLinkSpeed = (get-netadapter -CimSession $ClusterNode | Where-Object { $_.Status -eq &#34;up&#34; -and $_.HardwareInterface -eq $True }).Speed | Sort-Object -Descending | Select-Object -First 1
        #grab adapters
        $AdapterNames = (Get-NetAdapter -CimSession $ClusterNode | Where-Object { $_.Status -eq &#34;up&#34; -and $_.HardwareInterface -eq $True } | where-object Speed -eq $FastestLinkSpeed | Sort-Object Name).Name
        #$AdapterNames=&#34;SLOT 3 Port 1&#34;,&#34;SLOT 3 Port 2&#34;
        Import-Module NetworkATC
        Add-NetIntent -ClusterName $ClusterName -Name StorageIntent -Storage -AdapterName &#34;SMB01&#34;, &#34;SMB02&#34; -AdapterPropertyOverrides $AdapterOverride -Verbose
    }
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20151354.png" alt=""></p>
<p>We will add the default global intent manually since we are running this from the management server. I will be honest, I ony do this because I have seen it done with others.</p>
<pre tabindex="0"><code>    Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        Import-Module NetworkATC
        $overrides = New-NetIntentGlobalClusterOverrides
        #add empty intent
        Add-NetIntent -GlobalClusterOverrides $overrides
    }

    #check
    Start-Sleep 20 #let intent propagate a bit
    Write-Output &#34;applying intent&#34;
    do {
        $status = Invoke-Command -ComputerName $ClusterName -ScriptBlock { Get-NetIntentStatus }
        Write-Host &#34;.&#34; -NoNewline
        Start-Sleep 5
    } while ($status.ConfigurationStatus -contains &#34;Provisioning&#34; -or $status.ConfigurationStatus -contains &#34;Retrying&#34;)
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20084558.png" alt=""></p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20085051.png" alt=""></p>
<p>Now if we go to our Failover Cluster Manager we should be able to see the three switches now. The first is our converged management network for compute and management traffic The other two are our SMB traffic on two different vlans. This may take some time. Once this is complete then I will move forward with adding this node to the cluster.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20151817.png" alt=""></p>
<hr>
<h2 id="configure-cluster">Configure Cluster</h2>
<p>Nice, we are almost ready to join our second node to the cluster.  Networking is done and all the needed OS configurations are done. The next step can be completed after the cluster is joined but I do it right before.</p>
<h3 id="configure-witness">Configure Witness</h3>
<p>This is where we will create our Witness for our cluster. Since before it was only a single-node cluster we did not need a witness&hellip; (Can I get a Witness!) Anyway, for this lab I will create Fileshare witness on my domain controller. This is just a lab built to write this blog so please don&rsquo;t do this in any solution other than that. Either have a real file server that can be used or go with a Cloud Witness.</p>
<pre tabindex="0"><code>if ($WitnessType -eq &#34;FileShare&#34;) {
    ##Configure Witness on WitnessServer
    #Create new directory
    $WitnessName = $Clustername + &#34;Witness&#34;
    Invoke-Command -ComputerName $WitnessServer -ScriptBlock { new-item -Path c:\Shares -Name $using:WitnessName -ItemType Directory -ErrorAction Ignore }
    $accounts = @()
    $accounts += &#34;$env:userdomain\$ClusterName$&#34;
    $accounts += &#34;$env:userdomain\$env:USERNAME&#34;
    #$accounts+=&#34;$env:userdomain\Domain Admins&#34;
    New-SmbShare -Name $WitnessName -Path &#34;c:\Shares\$WitnessName&#34; -FullAccess $accounts -CimSession $WitnessServer
    #Set NTFS permissions
    Invoke-Command -ComputerName $WitnessServer -ScriptBlock { (Get-SmbShare $using:WitnessName).PresetPathAcl | Set-Acl }
    #Set Quorum
    Set-ClusterQuorum -Cluster $ClusterName -FileShareWitness &#34;\\$WitnessServer\$WitnessName&#34;
}
elseif ($WitnessType -eq $Cloud) {
    Set-ClusterQuorum -Cluster $ClusterName -CloudWitness -AccountName $CloudWitnessStorageAccountName -AccessKey $CloudWitnessStorageKey -Endpoint $CloudWitnessEndpoint
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20085208.png" alt=""></p>
<h3 id="add-node-to-cluster">Add Node To Cluster</h3>
<p>Now we can add the second node to the cluster. Very simple, the following PowerShell command is below. We could also do this from the Windows Admin Center as well.</p>
<pre tabindex="0"><code>Add-ClusterNode -Name $ClusterNode -Cluster $ClusterName
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20085731.png" alt=""></p>
<p>And after about 5 minutes we can start verifying that the cluster was added successfully. I am going to check first in the failover cluster manager. Here I can see my 2nd node is up and running.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20085922.png" alt=""></p>
<p>Next I will go into the Windows Admin Center to check on my cluster settings and see that the node has joined successfully. As you can see below, I do have an issue but it is expected. It will take a few minutes for my newly added node to get registered with Azure Arc-enabled servers. This will go green within the next 15 minutes or so.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20090902.png" alt=""></p>
<p>Then from within the Cluster I can click on Servers and see that both servers are up and running.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20090949.png" alt=""></p>
<p>Here we can check that our Network intent configurations have been provisioned successfully across all our nodes.</p>
<p>Check Network ATC settings</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20091812.png" alt=""></p>
<p>We can also check Failover Cluster manager to make sure that all our cluster networks are correctly configured. This make take some time so be patient.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20152941.png" alt=""></p>
<p>One of the last configurations for our cluster would be to disabled CSV cache if using SCM storage or if this is running on a virtual machine.</p>
<pre tabindex="0"><code>if (Get-PhysicalDisk -cimsession $ClusterNode | Where-Object bustype -eq SCM) {
    #disable CSV cache if SCM storage is used
        (Get-Cluster $ClusterName).BlockCacheSize = 0
}
elseif ((Invoke-Command -ComputerName $ClusterNode -ScriptBlock { (get-wmiobject win32_computersystem).Model }) -eq &#34;Virtual Machine&#34;) {
    #disable CSV cache for virtual environments
        (Get-Cluster $ClusterName).BlockCacheSize = 0
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20091100.png" alt=""></p>
<p>We are not done yet. There are some more network settings that have to be configured, storage settings, and we also need to enabled cluster aware updating and a few other things.</p>
<h2 id="install-network-hud-netatc">Install Network HUD (NetATC)</h2>
<p>Here we will install Network HUd on the second node. This was already installed on the first node previously.</p>
<pre tabindex="0"><code>Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        Install-WindowsFeature -Name &#34;NetworkHUD&#34;, &#34;Hyper-V&#34;, &#34;Hyper-V-PowerShell&#34;, &#34;Data-Center-Bridging&#34;, &#34;RSAT-DataCenterBridging-LLDP-Tools&#34;, &#34;NetworkATC&#34;, &#34;Failover-Clustering&#34;
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20092142.png" alt=""></p>
<pre tabindex="0"><code>$Modules = &#34;Test-NetStack&#34;, &#34;az.stackhci.networkhud&#34;
    Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
    foreach ($Module in $Modules) {
        #download module to management node
        Save-Module -Name $Module -Path $env:Userprofile\downloads\
        #copy it to servers
        foreach ($Server in $ClusterNode) {
            Copy-Item -Path &#34;$env:Userprofile\downloads\$module&#34; -Destination &#34;\\$Server\C$\Program Files\WindowsPowerShell\Modules\&#34; -Recurse -Force
        }
    }
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20092333.png" alt=""></p>
<pre tabindex="0"><code>    Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        Restart-Service NetworkHUD
    }
    #wait a bit
    Start-Sleep 10
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20092457.png" alt=""></p>
<pre tabindex="0"><code>    #check event logs
    $events = Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        Get-WinEvent -FilterHashtable @{&#34;ProviderName&#34; = &#34;Microsoft-Windows-Networking-NetworkHUD&#34;; Id = 105 }
    }
    $events | Format-Table -AutoSize
</code></pre><hr>
<h2 id="complete-netatc-configurations">Complete NetATC Configurations</h2>
<p>The finally steps to finish our network configuration using Network ATC. Here we will install and configure Data Center Bridging if needed. Then go through all the settings to see if they are configured correctly.</p>
<p>This step we will disable network adapters that we will not be using. Since this was a virtual environment and not physical I didn&rsquo;t have any network adapters that needed to be disabled.</p>
<pre tabindex="0"><code> Get-Netadapter -CimSession $ClusterNode | Where-Object Status -ne &#34;Up&#34; | Disable-NetAdapter -Confirm:0
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20092639.png" alt=""></p>
<p>Here is where I will configure Data center bridging.</p>
<pre tabindex="0"><code>    if ((Get-CimInstance -ClassName win32_computersystem -CimSession $ClusterNode).Manufacturer -like &#34;*Dell Inc.&#34;) {
        if (Get-NetAdapter -CimSession $ClusterNode -InterfaceDescription Mellanox*) {
            Set-NetAdapterAdvancedProperty -CimSession $ClusterNode -InterfaceDescription Mellanox* -DisplayName &#39;Dcbxmode&#39; -DisplayValue &#39;Host in charge&#39;
        }
    }
    #configure larger receive buffers on Mellanox adapters
    if ((Get-CimInstance -ClassName win32_computersystem -CimSession $ClusterNode).Manufacturer -like &#34;*Dell Inc.&#34;) {
        if (Get-NetAdapter -CimSession $ClusterNode -InterfaceDescription Mellanox*) {
            Set-NetAdapterAdvancedProperty -CimSession $ClusterNode -InterfaceDescription Mellanox* -DisplayName &#39;Receive buffers&#39; -DisplayValue &#39;4096&#39;
        }
    }
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20092726.png" alt=""></p>
<h3 id="check-netatc-configurations">Check NetATC Configurations</h3>
<p>Live Migration settings. This is where we would see what networks were exuded from Live Migration.</p>
<pre tabindex="0"><code>    $Networks = (Get-ClusterResourceType -Cluster $clustername -Name &#34;Virtual Machine&#34; | Get-ClusterParameter -Name MigrationExcludeNetworks).Value -split &#34;;&#34;
    foreach ($Network in $Networks) { Get-ClusterNetwork -Cluster $ClusterName | Where-Object ID -Match $Network }
</code></pre><p>I do want to call out something here that I noticed is happening.  For some reason my Cluster Network is being renamed during the process I am following. I am going to find out why or how or what is doing this.</p>
<p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20093052.png" alt=""></p>
<p>Check Live Migration options. Make sure it is configured to SMB.</p>
<pre tabindex="0"><code>Get-VMHost -CimSession $ClusterNode | Select-Object *Migration*
</code></pre><p>Check SMB Bandwidth settings limit.</p>
<pre tabindex="0"><code> Get-Cluster -Name $ClusterName | Select-Object *SMB*
</code></pre><pre tabindex="0"><code>Get-SmbBandwidthLimit -CimSession $ClusterNode
</code></pre><p>Check VLAN settings</p>
<pre tabindex="0"><code>Get-VMNetworkAdapterIsolation -CimSession $ClusterNode -ManagementOS
</code></pre><p>CHeck number of live migrations</p>
<pre tabindex="0"><code>get-vmhost -CimSession $ClusterNode | Select-Object Name, MaximumVirtualMachineMigrations
</code></pre><p>Check Cluster Overrides in Global Overrides</p>
<pre tabindex="0"><code>    Invoke-Command -ComputerName $ClusterName -ScriptBlock {
        Import-Module NetworkATC
        $GlobalOverrides = Get-Netintent -GlobalOverrides
        $GlobalOverrides.ClusterOverride
    }
</code></pre><hr>
<h3 id="enable-cluster-aware-updating">Enable Cluster-Aware-Updating</h3>
<p>Now we can enable cluster-aware-updating.  This can be done again in the Windows Admin Center but I will do it via PowerShell.</p>
<pre tabindex="0"><code>if ($CAURoleName) {
    #Install required features on nodes.
    Invoke-Command -ComputerName $ClusterNode -ScriptBlock {
        Install-WindowsFeature -Name RSAT-Clustering-PowerShell
    }
    #add role
    Add-CauClusterRole -ClusterName $ClusterName -MaxFailedNodes 0 -RequireAllNodesOnline -EnableFirewallRules -GroupName $CAURoleName -VirtualComputerObjectName $CAURoleName -Force -CauPluginName Microsoft.WindowsUpdatePlugin -MaxRetriesPerNode 3 -CauPluginArguments @{ &#39;IncludeRecommendedUpdates&#39; = &#39;False&#39; } -StartDate &#34;3/2/2017 3:00:00 AM&#34; -DaysOfWeek 4 -WeeksOfMonth @(3) -verbose
    #disable self-updating
    Disable-CauClusterRole -ClusterName $ClusterName -Force
}
if ($KSR) {
    #list cluster parameters - as you can see, CauEnableSoftReboot does not exist
    Get-Cluster -Name $ClusterName | Get-ClusterParameter
    #let&#39;s create the value and validate
    Get-Cluster -Name $ClusterName | Set-ClusterParameter -Name CauEnableSoftReboot -Value 1 -Create
    Get-Cluster -Name $ClusterName | Get-ClusterParameter -Name CauEnableSoftReboot
    #to delete it again you can run following command
    #Get-Cluster -Name $ClusterName | Set-ClusterParameter -Name CauEnableSoftReboot -Delete
}
</code></pre><p><img src="/img/azshci-series/part-iv/Screenshot%202023-10-23%20154049.png" alt=""></p>
<hr>
<h2 id="configure-cluster-storage">Configure Cluster Storage</h2>
<h3 id="storage-fault-domain-changes">Storage Fault Domain Changes</h3>
<pre tabindex="0"><code>#configure storage pool
Set-StoragePool -CimSession $ClusterName -FriendlyName &#34;S2D on $ClusterName&#34; -FaultDomainAwarenessDefault StorageScaleUnit
</code></pre><pre tabindex="0"><code>Get-VirtualDisk -CimSession $ClusterName | Select-Object FriendlyName, FaultDomainAwareness
</code></pre><pre tabindex="0"><code>Invoke-Command -ComputerName $clusterName -ScriptBlock { Stop-ClusterPerformanceHistory -DeleteHistory }
#recreate performance history
Start-ClusterPerformanceHistory -CimSession $ClusterName
</code></pre><pre tabindex="0"><code>Get-VirtualDisk -CimSession $ClusterName | Select-Object FriendlyName, FaultDomainAwareness
</code></pre><h3 id="create-volumes">Create Volumes</h3>
<pre tabindex="0"><code>Get-StoragePool -FriendlyName &#34;S2D on $ClusterName&#34; -CimSession $ClusterName | Set-StoragePool -ProvisioningTypeDefault Thin
</code></pre><pre tabindex="0"><code>#create 1TB volume on each node
foreach ($Server in $ClusterNode) {
    New-Volume -StoragePoolFriendlyName  &#34;S2D on $ClusterName&#34; -FriendlyName $Server -Size 1TB -CimSession $ClusterName
}
</code></pre><h3 id="align-volumes">Align Volumes</h3>
<pre tabindex="0"><code>#align volumes ownership to with servers
foreach ($Server in $ClusterNode) {
    Move-ClusterSharedVolume -Name &#34;Cluster Virtual Disk ($Server)&#34; -Node $Server -Cluster $ClusterName
}
</code></pre><hr>
<h2 id="verify-and-testify">Verify and Testify?</h2>
<p>So, at this time I have a fully functional two-node Azure Stack HCI cluster ready to have workloads deployed to it. At this point we can go through and verify everything is running. That both nodes are connected, that our networks are up and running, and that all our small configurations have been applied. We can verify that our nodes show up in Azure as Arc-enabled servers, and that our Azure Stack HCI cluster is also being managed and is registered with Azure.  We should verify our storage is working and that all our volumes are good for workload placements.  I will even try to do an update via the Update manager from within the Windows Admin Center to make sure everything there is working as well.</p>
<p>There are handful of other settings that can be configured. For instance, configuring fault domains for the new node, configuring the default location for VM&rsquo;s on our volumes, etc.  But for now, this is where the blog shall end.</p>
<hr>
<h2 id="final-thoughts">Final Thoughts</h2>
<p>So, I do want to stress. This deployment I just walked through is not production ready. It will be good for getting your feet wet with Azure Stack HCI. For most of use we donâ€™t have a lot of hardware that would be supported for HCI sitting around. We may have a few older servers that we can use, even deploy this same solution on that single physical server to have a multi-node solution, or use an AzureVM which can be very expensive. This blog I hope helped someone get an idea of that they would need to do to get started. Moving forward, I will blog about scaling out this single node cluster to a two node cluster and then to a three and four node cluster after that.</p>
<p>I also didn&rsquo;t cover how you would cable a two node cluster. THere are a few different ways that it can be done. We could go switchless for compute and storage or introduce a top of the rack switch.</p>
<p>Also, this blog just touches on the deployment of an Azure Stack HCI cluster. There is so much more and we can really go into depth of what Azure Stack HCI can do along with Azure Arc. I will be blogging a lot on these subjects moving forward.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/azure-stack-hci/" rel="tag">Azure Stack HCI</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/powershell/" rel="tag">PowerShell</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/windows-admin-center/" rel="tag">WIndows Admin Center</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Kristopher J Turner avatar" src="/img/me.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Kristopher J Turner</span>
	</div>
	<div class="authorbox__description">
		I am a Microsoft MVP currently living in Texas. My interests range from technology to homesteading. I also love spending time in the woodshop, making things out of wood with my hands.
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/post/azure-stack-hci-part-iii-advanced-deployment-single-node-cluster/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Azure Stack HCI - Part III - Advanced Deployment of A Single Node Cluster</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/post/azure-stack-hci-part-sixteen/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">Azure Stack HCI - Part V - From one to Sixteen</p>
		</a>
	</div>
</nav>

<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "thisismydemo-cloud" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCHâ€¦" value="" name="q" aria-label="SEARCHâ€¦">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="http://thisismydemo.cloud/">
	</form>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/12-days-azure-arc-mas-apps-deploying/">The 12 Days of Azure Arc-Mas - Six Apps Deploying</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/12-days-azure-arc-mas-golden-savings/">The 12 Days of Azure Arc-Mas - Five Golden Savings</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/12-days-azure-arc-mas-nodes-connecting/">The 12 Days of Azure Arc-Mas - Four Nodes Connecting</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/12-days-azure-arc-mas-services-scaling/">The 12 Days of Azure Arc-Mas - Three Services Scaling</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/12-days-azure-arc-mas-clusters-flexing/">The 12 Days of Azure Arc-Mas - Two Clusters Flexing</a></li>
		</ul>
	</div>
</div>
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item">
				<a class="widget__link" href="/categories/azure-active-directory/">Azure Active Directory</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/azure-arc/">Azure Arc</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/azure-arc-enabled-kubernetes/">Azure Arc-Enabled Kubernetes</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/azure-arc-enabled-servers/">Azure Arc-Enabled Servers</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/azure-files/">Azure Files</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/azure-percept-development-kit/">Azure Percept Development Kit</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/azure-site-recovery/">Azure Site Recovery</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/azure-sphere-development-kit/">Azure Sphere Development Kit</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/azure-stack-hci/">Azure Stack HCI</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/cross-tenant-synchronization/">Cross-Tenant Synchronization</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/dfwsmug/">DFWSMUG</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/entra-permissions-management/">Entra Permissions Management</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/festive-tech-calendar/">Festive Tech Calendar</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/home-assistant/">Home Assistant</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/intune/">Intune</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/intune-proactive-remediation/">Intune Proactive Remediation</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/microk8s/">MicroK8S</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/microsoft-sentinel/">Microsoft Sentinel</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/vision-ai-developer-kit/">Vision AI Developer Kit</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/windows-terminal/">Windows Terminal</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/azure/" title="Azure">Azure</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-ad/" title="Azure AD">Azure AD</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-arc/" title="Azure Arc">Azure Arc</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-arc-enabled-data-services/" title="Azure Arc-enabled Data Services">Azure Arc-enabled Data Services</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-arc-enabled-kubernetes/" title="Azure Arc-enabled Kubernetes">Azure Arc-enabled Kubernetes</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-arc-enabled-servers/" title="Azure Arc-enabled servers">Azure Arc-enabled servers</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-arc-mas/" title="Azure Arc-Mas">Azure Arc-Mas</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-devops/" title="Azure DevOps">Azure DevOps</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-files/" title="Azure Files">Azure Files</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-iot/" title="Azure IoT">Azure IoT</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-kubernetes-service/" title="Azure Kubernetes Service">Azure Kubernetes Service</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-managed-grafana/" title="Azure Managed Grafana">Azure Managed Grafana</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-managed-prometheus/" title="Azure Managed Prometheus">Azure Managed Prometheus</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-monitor/" title="Azure Monitor">Azure Monitor</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-percept/" title="Azure Percept">Azure Percept</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-percept-development-kit/" title="Azure Percept Development Kit">Azure Percept Development Kit</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-site-recovery/" title="Azure Site Recovery">Azure Site Recovery</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-sphere/" title="Azure Sphere">Azure Sphere</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-sphere-development-kit/" title="Azure Sphere Development Kit">Azure Sphere Development Kit</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-stack-hci/" title="Azure Stack HCI">Azure Stack HCI</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cloud-family/" title="Cloud Family">Cloud Family</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/containers-insights/" title="Containers Insights">Containers Insights</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cross-tenant-synchronization/" title="Cross-Tenant Synchronization">Cross-Tenant Synchronization</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/dfwsmug/" title="DFWSMUG">DFWSMUG</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/endpoint-management/" title="Endpoint Management">Endpoint Management</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/entra-permissions-management/" title="Entra Permissions Management">Entra Permissions Management</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/festive-tech-calendar/" title="Festive Tech Calendar">Festive Tech Calendar</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/freshservice/" title="FreshService">FreshService</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/front-matter/" title="Front Matter">Front Matter</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/github/" title="GitHub">GitHub</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/github-pages/" title="GitHub Pages">GitHub Pages</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/google-cloud-platform/" title="Google Cloud Platform">Google Cloud Platform</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/home-assistant/" title="Home Assistant">Home Assistant</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/home-automation/" title="Home Automation">Home Automation</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/hugo/" title="Hugo">Hugo</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/intune/" title="Intune">Intune</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/iot-edge/" title="Iot Edge">Iot Edge</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/kubernetes/" title="Kubernetes">Kubernetes</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/microsk8s/" title="MicrosK8S">MicrosK8S</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/microsoft-entra/" title="Microsoft Entra">Microsoft Entra</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/microsoft-sentinel/" title="Microsoft Sentinel">Microsoft Sentinel</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/permissions-management/" title="Permissions Management">Permissions Management</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/poractive-remediation/" title="Poractive Remediation">Poractive Remediation</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/powershell/" title="PowerShell">PowerShell</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/proactive-remediation/" title="Proactive Remediation">Proactive Remediation</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/the-festive-tech-calendar/" title="The Festive Tech Calendar">The Festive Tech Calendar</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/the-microsoft-425show/" title="The Microsoft 425Show">The Microsoft 425Show</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/vision-ai-developer-kit/" title="Vision AI Developer Kit">Vision AI Developer Kit</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/wac/" title="WAC">WAC</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/windows-admin-center/" title="Windows Admin Center">Windows Admin Center</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/windows-server/" title="Windows Server">Windows Server</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/windows-terminal/" title="Windows Terminal">Windows Terminal</a>
	</div>
</div>
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="LinkedIn" rel="noopener noreferrer" href="https://linkedin.com/in/KristopherJTurner" target="_blank">
				<svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/thisismydemo" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>

		
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 This Is My Demo.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>